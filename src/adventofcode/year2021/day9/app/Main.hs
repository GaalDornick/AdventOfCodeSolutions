module Main where

import Data.Array (range)
import Data.Char (digitToInt)
import qualified Data.Map as Map
import Data.Maybe (fromJust, maybeToList)
import Debug.Trace (trace)
import Data.List(sort)

traceCall :: Show a => a -> a
traceCall a = trace(show(a)) a

flatMap :: ( b -> [a]) -> [b] -> [a]
flatMap mapFunc input = foldl (++) [] (map mapFunc input)

type Point = (Int, Int)

type Grid k = Map.Map Point k
grid :: [k] -> Point -> Grid k
grid elems (width, height) = let start = (0,0)
                                 end =  (width-1, height-1)
                                 coords = range(start, end)
                                 points = map(\(x, y) -> ((x, y), elems !! (y*width+x))) coords
                             in Map.fromList(points)

elemRender :: Show k => Grid k->Int->Int->String
elemRender grid y x = show(gridElemAt grid (x,y))

lineRender :: Show k => Grid k -> [Int] -> Int -> String
lineRender grid xRange y = foldl (++) "" (map(elemRender grid y) xRange)

renderGrid :: Show k => Grid k -> String
renderGrid grid 
    | Map.null grid = "EMPTY"
    | otherwise = let coords = Map.keys grid
                      maxX = maximum(map fst coords)
                      maxY = maximum(map snd coords)
                      xRange = range(0, maxX)
                      yRange = range(0, maxY)
                   in foldl (\a b -> a ++ "\n" ++ b) "" (map (lineRender grid xRange) yRange)


gridElemAt :: Grid k -> Point-> [k]
gridElemAt elems coord = maybeToList(Map.lookup coord elems)


neighborCoords :: Point ->  [Point]
neighborCoords (x, y)  = let left    = [(x-1  , y)] 
                             top     = [(x    , y-1)]
                             right   = [(x+1  , y)]
                             bottom  = [(x    , y+1)]
                          in left ++ top ++ right ++ bottom


neighbors :: Point -> Grid k -> [k]
neighbors point grid = let coords = neighborCoords point
                       in flatMap (gridElemAt(grid)) coords

allCoords:: Grid k -> [(Point)]
allCoords elems = Map.keys elems

input :: Grid Char
-- input =  grid "21999432103987894921985678989287678967899899965678" (10,5)
input = grid "9876567896542101249889965434567898765698785435678989898897654789424901245699887678932398943999888667599545697654329439876789622345678965498865452359997667778976567891989345698977658789198789989876545669765778976649899854589890123456789698765432123889654356789967899097895798765434567899967897898943477988678989979876564344678923576789989997432101267896323499989898898678999998432345899985345678932123899878986789199843212379993967899989997654324345898654568986998767456798998754346789987425789965399999998987568909865733349878989899897899876543678678976567998789985434598767976656789019653467898698789899999646789987654579876567898775679998965489989998767899989019651279765798786989219875457896998767878979875678929877768998767998765459899999679759789987899999919876299875456998789542399656793498765666796599878943998887989989898765434978999879654569539899989989998798965434569989765345977897598765475589943198965989999897899492998612986789998954349892199987687889998794332346799989645679898967965431346989423989987654395678932129910197567998942129878909899654567898765320123678989989878998789987667223457893457987654323466954909854239867898799101976789879876578999985432123458976799298998969899879831234689956789854301234579989976639897897567891997569896599868998987654324596896578910998745878998754234578989789296921934598987989779878999545687987545678947697999769986553778891234592198763456989876564568987989012989989968987687899876567893459679653457993249898965498767456893023998998765476797698767587897689432987887989997657567894345693233459874234678912398765434998656793212989678987756789643987879897656899987677657789654347996545678910239876212348932348988675578976789434987659899876789654239898994354569879853254567896325689976978989129875420123954346789878678998789959987654567898789843214590987321249876543101267896521456789789967894599653423569545989999878999989789854321239899989876532967196543396898765327437897641036789999645678969876954567895679989698999879569876543019899989899864979898765498998999853654679953212789989753456989999789967899679987855999876545698965429878987679897986896998659789789876476567896793345897683234567899999987897898998654359876543756987669896797659878987543510989865467798658767898785445678943212678899987679895679998754329876543234579879876589673876999643243159865434569976789899989999678965693359999987653295456894998569886643212345698998969543236579875715423498642347899789496889987898987698946789999854101234599398767976543210145778954987893212345898430543998765645678989234567896698999898795679789894321234567893987898785432123689989219896210123678932179987987989878999212345689456798998768979769876577238767895489892989754324456897892997532134456789329886649899198988430345678936799786765689765698876545687899956994349996547556895678987654567576789545876543498901987652123456964798765455459965476998765699898989986545698769866789468959876567868999769699767656789299984323496789569878332234989434598997898998767999769678987897889234994398789997932399879897878789997987653658989769876521014587894598769898776655689989898989899899312678921999999890145698879898989987659896796789988998743212345678999865594965423467899878987990295420125989098789892123679976899949398754398798789259956985445365689998975432398621245598976745678939653543456798965678923578924567943129876623989989213989987656697879998795432124983012346789543456999878465456798765456789469921345932109876501239999210197879877778898998968932101396432345679765234599998657756798765434345956789023989399876541236897642198656699989995998765795443298654345679685312378894997876798987632123789789219497898999953234569765439754358999886498768478995449876545678954320145679329898799769894324567899652897686789876434567899659876746789876534995426568965698778788976562123456921098998765797543467899654376546567898766568997896798989789876432998631345987678988989998754323498789298769765498765457899896566543445678989778956678989939989498656987654249699878989929986976543456789998665989434987656899879767765153456789989943457999854569534989789897539898898987821296598775756789998755459932139976794876899887101234589899101256789976567892329989698769877678999661098543988696789889954634984424598789323567999321234667965431249989798767992101239654989876456789954398743239989899767896332987643467989201345689543234567897654245899567989894335689654329876533456789598765215989999845688910129877657899321245678965976567899878435678946239997648779876546976541234567892987890187899973497789229998877899899995978907679787894599756778943219989885989598969798743034568994398732124679876234567939899998999678878998921878989892398796788999439887999679545999899984212667898545954343567896544567899879899998756756789993298939692198765989978899867689989543569878997632345898767689547478998767897899986979898764234799278937932356929854329545678965657889653235696598654345678989879865656789987899899986545877988765589436789654146789977321012456789454567893212379842978545679939398987676989319899999987662345689988789654589554323799876544323967799432347995432349874398965678932123949878999799990987899852123467999989976579947654567898878643989998954545988954345976545987678954493913598998769892197679654303457897659398778989876987999999765497686799565987789945789865679878989598989767998965479398659876541259898654323988967898789989988987698654567897987656789678997698998967998797897899795436799954398743234599954321239965677989997896799898765347899899854569998989878998965988964569899865432568954321986445578989932019765456649798672578898765323456794596578988996598998765456795347892198432146789943979756978967789219865434553459754146678987841234899398769987678943956987534578923458909976323456789976989789935667892499856564239864303458999894234567892999899656910234989884878921456789896543456799986569989432345698956976798319987821236789876564567890198878994599129987897678953034569878965486789987545659953123498789989789942899893434789999767897898998765678998899896569878973212347996789657989996543234789201349867987999545678999656789799987899995767998345789767678967998976532367987579877899998975634567921299875532678995698999876789567899899986454569545689765458989895989774545999545998999989799679677893298998432155688998998998789845690199987534349765689337434567893456798565999893989999897967899898997498789754103456788798789989573498929987642123988989421012345891234567967987673267899875685889878998659867896541236789468567899743156789899854323459989543499949691012677987899843215699976453467896798989865678953234589234345679865424599879876544569887896598789893212345699891098432456998431235993456789877456995464569432123456797656567896499766569877679998765678932457998997998764556789965654789234678976534678998567894323459789999769894534987969876756789965436789345989756689997677899987776569212356789432355989877896543457989998899994312999899876564589998654589545987984456459878999899898767890129899632123467898899865477899998678898740989999898742347899876767895987654320136798989578997987894329898954433577894999897656799987654568965987899876543123678998789999989876563124789997545987659896549878789595458991239878998789899874345679987678498973101356892989467897699875456989997672109864398789876767998676789234976799989678998523456987656234998421234793139435697654398656989987654329798323999776545789878789539987567969456987631345698654312349956237689109854678945223976987889897649864320298763212469998989769877646685434569654245699979310129876545679429876578953210198989676799876797844198765432456789939199876543457432459876436678998765178998765678993498767987432123987843567898789876323987987656789892101298764257655679599854568920987435789987689978956997899869323987673259899989876543589939876789778991299986536978679542976567893987654569769899656789799991099893469853214878999898765467892199789456798998998764598998969199887895459876587895697654567898989235979997976210356789767998769894349989234598788789989678954999898999897956798969891459854345698767894986878999792123489985431989896599879901598767567989898954349878799997679899997893239876323698765679986596999898923479999954239979998976789298765647987978906565976765789658999989899939876521379765476896543569876789456789989599886789764567899975433459656891867976555456796789896897989998543549865434578943249876568956799467898776598995345698987632129896789299986544434568989879567587898766579874212356793219896546997789769898765645678923498765432109878989439877843312345789876541245696987789876530123789432979795699899987898765433548953478988664329876789654876543210355689876572047679549889898754543459999986898978995469899965432123895456789996549876567896798765563145878996543212979543499678986875678998897476789996439999998765345678968989998769998747898786987787323458998965432379965212456789798678998777634567898759789989987845678997899789999894323699989559889895456998789776356789910134567989978999766452346796989869867899875698999895556798764321456999944599997676988769996545789989329567899298998765432123489549895435598999678999896434567987521014789893358999878987855798965689987999897993210998987654101247899878942345789878998765432017986543212399976225678998987654468789989987678978989432198759878561334567896792145678998999997654312898766434345789510345987959874323567899989656456987954523994398967234567894568929678956987898976692398987656746889342129889643498321768899987854134987689943998921987854578891256799898934987676789778349769876989799423534567979198754237999899654302987656789987789239898768993234568978932987656567988949895998789989891279567899899986734989879876321987654567897667994599989965438677956794999654347989999878988989429679238987999878998794567896496544349896777895445678967899329654989894898987654323456789876987769321259894949999876789989567895434987645699788995433458997999759876789494376789986541038789998539654321034578953239877567899879897652129895678989965631256789899876798789434323567898765212399998769876544212568956212976545678998999986433497678999765431016789990198789989432101245678989432445689989998765632867934" (100, 100)

isLowPoint :: (Char, String) -> Bool
isLowPoint (elem, neighbors) = length (filter (<=elem) neighbors) == 0


findBasins :: Grid Char -> [[Point]]
findBasins grid 
    | Map.null grid = [] -- grid is empty.. so stop here
    | otherwise     = let firstPoint = head(Map.keys grid)
                          (basinAtPoint, remainingGrid) = findBasinAtPoint grid firstPoint
                      in basinAtPoint:findBasins(remainingGrid)
                    
                    
findBasinAtPoint :: Grid Char -> Point -> ([Point], Grid Char)
findBasinAtPoint grid point = let elemAtPoint = trace(show(point))(gridElemAt grid point)
                                  gridWithoutPoint = Map.delete point grid
                              in case elemAtPoint of []     -> ([], grid) -- nothing here stop recursion
                                                     ['9']    -> ([], gridWithoutPoint) -- basin wall remove aand stop recursion
                                                     [elem] -> let candidates = neighborCoords point 
                                                                   (candidateBasin, remainingGrid) = findBasinAtMultiplePoint gridWithoutPoint candidates
                                                               in (point:candidateBasin, remainingGrid)

findBasinAtMultiplePoint :: Grid Char -> [Point] -> ([Point], Grid Char)
findBasinAtMultiplePoint grid points = foldl (\(accPoints, accGrid) curr -> let (foundBasin, remainingGrid) = findBasinAtPoint accGrid curr 
                                                                    in (accPoints ++ foundBasin, remainingGrid)
                                             ) ([], grid) points
                                                  

main :: IO ()
main = do
    putStrLn(show(input))
    let coords = allCoords input
    let elemsWithNeighbors = map (\point -> (head(gridElemAt(input)(point)), neighbors(point)(input))) coords
    putStrLn(show(elemsWithNeighbors))
    let lowPoints = map(fst)(filter(isLowPoint) elemsWithNeighbors)
    putStrLn(show(lowPoints))
    let riskScores = map(\c -> digitToInt(c) + 1) lowPoints
    putStrLn(show(sum(riskScores)))
    let basins = findBasins input
    putStrLn(show(basins))
    let basinSizes = reverse(sort(map (length) basins))
    putStrLn(show basinSizes)
    let result = foldl (*) 1 (take 3 basinSizes)
    putStrLn(show result)

